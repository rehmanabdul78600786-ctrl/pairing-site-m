const express = require("express");
const fs = require("fs");
const path = require("path");
const os = require("os");
const P = require("pino");
const { default: makeWASocket, useMultiFileAuthState, fetchLatestBaileysVersion } = require("@whiskeysockets/baileys");

const app = express();
const PORT = process.env.PORT || 3000;

let sock;

// Ensure session folder exists
const sessionPath = path.join(__dirname, "session");
if (!fs.existsSync(sessionPath)) fs.mkdirSync(sessionPath);

// Start Bot
async function startBot() {
  const { state, saveCreds } = await useMultiFileAuthState(sessionPath);
  const { version } = await fetchLatestBaileysVersion();

  sock = makeWASocket({
    logger: P({ level: "silent" }),
    version,
    auth: state,
    printQRInTerminal: false,
  });

  sock.ev.on("creds.update", saveCreds);

  sock.ev.on("connection.update", async (update) => {
    const { connection } = update;

    if (connection === "open") {
      console.log("âœ… Bot Connected");

      const credsFile = path.join(sessionPath, "creds.json");

      const styledMessage = `
â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚  ðŸ‘‘ BOSS-MD OFFICIAL ðŸ‘‘  â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

[ðŸš€] System : SESSION CONNECTED
[ðŸ¤–] Bot     : BOSS-MD
[ðŸ’»] Engine  : NodeJs + Baileys MD
[ðŸŒ] Host    : Render Cloud
[âš™ï¸] Mode    : Public
[ðŸ”–] Version : 2.0.0
[ðŸ‘‘] Owner   : BOSS Official

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ðŸ”¥ SESSION FILE READY
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
`;

      if (fs.existsSync(credsFile)) {
        // 1ï¸âƒ£ Send Picture + Styled Message
        await sock.sendMessage(sock.user.id, {
          image: { url: "https://files.catbox.moe/cbgxpq.jpg" },
          caption: styledMessage
        });

        // 2ï¸âƒ£ Send Session File
        await sock.sendMessage(sock.user.id, {
          document: fs.readFileSync(credsFile),
          fileName: "session.json",
          mimetype: "application/json",
          caption: "ðŸ“„ BOSS-MD SESSION FILE"
        });

        // 3ï¸âƒ£ Optional: Timestamp
        const timeNow = new Date().toLocaleString();
        await sock.sendMessage(sock.user.id, { text: `â° Timestamp: ${timeNow}` });

        // 4ï¸âƒ£ Optional: RAM Usage
        await sock.sendMessage(sock.user.id, {
          text: `ðŸ’» RAM Usage: ${Math.round((os.totalmem()-os.freemem())/1024/1024)}MB / ${Math.round(os.totalmem()/1024/1024)}MB`
        });

        // 5ï¸âƒ£ Optional: Pairing Sound
        await sock.sendMessage(sock.user.id, {
          audio: { url: "https://files.catbox.moe/uv4372.mp3" },
          mimetype: "audio/mp3"
        });
      }
    }

    if (connection === "close") {
      console.log("âŒ Connection Closed. Restarting...");
      startBot();
    }
  });
}

startBot();

// =========================
// PAIRING ROUTE
// =========================
app.get("/code", async (req, res) => {
  let number = req.query.number;
  if (!number) return res.json({ code: "Number Missing" });

  // Remove non-digits and auto Pakistan country code
  number = number.replace(/[^0-9]/g, "");
  if (number.startsWith("0")) number = "92" + number.slice(1);

  try {
    const code = await sock.requestPairingCode(number);
    res.json({ code });
  } catch (err) {
    console.log(err);
    res.json({ code: "Error Generating Code" });
  }
});

// =========================
// START SERVER
// =========================
app.listen(PORT, () => {
  console.log(`ðŸš€ Server running on port ${PORT}`);
});
